let baseImages = [];
let watermarkImage;
let watermarkSize = 100;
let watermarkPosition = 'center';

function setup() {
  noLoop(); // Disable continuous drawing

  // Set up event listeners
  document.getElementById('baseImageUpload').addEventListener('change', handleBaseImageUpload);
  document.getElementById('watermarkUpload').addEventListener('change', handleWatermarkUpload);
  document.getElementById('watermarkSize').addEventListener('input', handleWatermarkSizeChange);
  document.getElementById('watermarkPosition').addEventListener('change', handleWatermarkPositionChange);
  document.getElementById('downloadWatermarkedImages').addEventListener('click', downloadWatermarkedImages);
}

function drawImages() {
  if (baseImages.length > 0 && watermarkImage) {
    document.getElementById('previewContainer').innerHTML = ''; // Clear previous previews

    baseImages.forEach((baseImage, index) => {
      // Set canvas size to match image
      createCanvas(baseImage.width, baseImage.height);
      background(255);

      // Draw the base image
      image(baseImage, 0, 0, width, height);

      // Calculate watermark position
      let x, y;
      if (watermarkPosition === 'center') {
        x = (width - watermarkSize) / 2;
        y = (height - watermarkSize) / 2;
      } else if (watermarkPosition === 'upper-left') {
        x = 0;
        y = 0;
      } else if (watermarkPosition === 'upper-right') {
        x = width - watermarkSize;
        y = 0;
      } else if (watermarkPosition === 'bottom-left') {
        x = 0;
        y = height - watermarkSize;
      } else if (watermarkPosition === 'bottom-right') {
        x = width - watermarkSize;
        y = height - watermarkSize;
      }

      // Draw watermark
      image(watermarkImage, x, y, watermarkSize, watermarkSize);

      // Convert canvas to image URL for preview
      const imageURL = canvas.toDataURL('image/png');

      // Create image element for preview
      const img = document.createElement('img');
      img.src = imageURL;
      img.classList.add('preview-image');
      img.alt = `Watermarked Image ${index + 1}`;

      // Append image to preview container
      document.getElementById('previewContainer').appendChild(img);
    });
  }
}

function handleBaseImageUpload(event) {
  const files = event.target.files;
  if (files.length > 0) {
    baseImages = Array.from(files).map(file => loadImage(URL.createObjectURL(file), drawImages));
  }
}

function handleWatermarkUpload(event) {
  const file = event.target.files[0];
  if (file && file.type.startsWith('image/')) {
    watermarkImage = loadImage(URL.createObjectURL(file), drawImages);
  }
}

function handleWatermarkSizeChange() {
  watermarkSize = parseInt(document.getElementById('watermarkSize').value, 10);
  drawImages();
}

function handleWatermarkPositionChange() {
  watermarkPosition = document.getElementById('watermarkPosition').value;
  drawImages();
}

function downloadWatermarkedImages() {
  if (baseImages.length > 0 && watermarkImage) {
    baseImages.forEach((baseImage, index) => {
      // Set canvas size to match image
      createCanvas(baseImage.width, baseImage.height);
      background(255);

      // Draw the base image
      image(baseImage, 0, 0, width, height);

      // Calculate watermark position
      let x, y;
      if (watermarkPosition === 'center') {
        x = (width - watermarkSize) / 2;
        y = (height - watermarkSize) / 2;
      } else if (watermarkPosition === 'upper-left') {
        x = 0;
        y = 0;
      } else if (watermarkPosition === 'upper-right') {
        x = width - watermarkSize;
        y = 0;
      } else if (watermarkPosition === 'bottom-left') {
        x = 0;
        y = height - watermarkSize;
      } else if (watermarkPosition === 'bottom-right') {
        x = width - watermarkSize;
        y = height - watermarkSize;
      }

      // Draw watermark
      image(watermarkImage, x, y, watermarkSize, watermarkSize);

      // Convert canvas to data URL
      const imageURL = canvas.toDataURL('image/png');

      // Trigger download of the image
      const a = document.createElement('a');
      a.href = imageURL;
      a.download = `watermarked_image_${index + 1}.png`;
      a.click();
    });
  }
}
